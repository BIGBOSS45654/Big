<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Algen-_- â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ù„Ø§ÙŠØ³ØªÙŠØ´Ù†</title>
  <style>
    :root{
      --bg:#07060b; --card:#0f0b16; --muted:#97a0b5;
      --accent1:#8a2be2; --accent2:#00c0ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Tahoma,Arial,Helvetica,sans-serif;background:radial-gradient(1200px 400px at 10% 10%, rgba(138,43,226,0.06), transparent), radial-gradient(900px 300px at 90% 90%, rgba(0,192,255,0.04), transparent),var(--bg);color:#e9f2ff}
    .wrap{max-width:980px;margin:18px auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:20px}
    .subtitle{color:var(--muted);font-size:13px}
    .btn{background:linear-gradient(90deg,var(--accent1),var(--accent2));border:none;padding:10px 12px;border-radius:10px;color:#fff;cursor:pointer;font-weight:600}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px;border-radius:10px}
    .card{margin-top:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent),var(--card);border-radius:14px;padding:14px;border:1px solid rgba(255,255,255,0.03)}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
    .devices{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:12px}
    .dev{border-radius:12px;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);position:relative;overflow:hidden}
    .dev h3{margin:0 0 6px 0}
    .muted{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;align-items:center;margin-top:10px}
    .select{padding:6px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .small{padding:6px 8px;font-size:13px;border-radius:8px}
    .panel{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.03)}
    .rate-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(90deg, rgba(138,43,226,0.02), rgba(0,192,255,0.02));border:1px solid rgba(255,255,255,0.02);margin-bottom:6px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{text-align:right;padding:8px;border-bottom:1px solid rgba(255,255,255,0.02);font-size:14px}
    .big-total{font-size:20px;font-weight:800;color:var(--accent1);text-align:left}
    /* floating record icon */
    .record-btn{
      position:fixed; left:18px; bottom:18px; z-index:9999;
      width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;font-weight:700;border:none;box-shadow:0 8px 30px rgba(0,0,0,0.5);cursor:pointer;
    }
    .record-btn span{font-size:11px;display:block;line-height:1;text-align:center}
    /* history modal */
    .modal{position:fixed; inset:0;background:rgba(2,6,23,0.7);display:none;align-items:center;justify-content:center;padding:20px;z-index:10000}
    .modal .box{width:100%;max-width:820px;background:var(--card);border-radius:12px;padding:12px;box-shadow:0 10px 40px rgba(0,0,0,0.6);}
    .modal header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .close{background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:16px}
    .history-table{max-height:60vh;overflow:auto}
    @media(max-width:900px){ .grid{grid-template-columns:1fr} .devices{grid-template-columns:1fr} .record-btn{left:12px;bottom:12px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Algen-_-</h1>
        <div class="subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø¨Ù„Ø§ÙŠØ³ØªÙŠØ´Ù† â€” Ù†Ù‡Ø§Ø¦ÙŠ</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="collectAll()">ØªØ­ØµÙŠÙ„ Ø§Ù„ÙƒÙ„</button>
        <button class="ghost" onclick="resetAll()">ØªØµÙÙŠØ± Ø§Ù„ÙƒÙ„</button>
      </div>
    </header>

    <div class="grid">
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="muted">Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©</div>
            <div class="muted">Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª â€” ÙŠØ­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§</div>
          </div>

          <div class="devices" id="devices"></div>

          <div class="muted" style="margin-top:10px">Ø§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£" Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©ØŒ Ø§Ø®ØªØ± "Ù…Ù„ØªÙŠ" Ù„Ùˆ 4 Ø¯Ø±Ø§Ø¹Ø§Øª.</div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®ØªØµØ± (Ø§Ø®Ø± Ø§Ù„Ø¬Ù„Ø³Ø§Øª)</h3>
          <div id="sessions_table"></div>
        </div>
      </div>

      <aside>
        <div class="panel">
          <h3 style="margin:0 0 8px 0">Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</h3>
          <div class="rate-row"><div>PS5 â€” Ø¹Ø§Ø¯ÙŠ (60 Ø¯Ù‚ÙŠÙ‚Ø©)</div><div><strong>45 Ø¬</strong></div></div>
          <div class="rate-row"><div>PS5 â€” Ù…Ù„ØªÙŠ (4 Ø¯Ø±Ø§Ø¹Ø§Øª)</div><div><strong>55 Ø¬</strong></div></div>
          <div class="rate-row"><div>PS4 â€” Ø¹Ø§Ø¯ÙŠ (60 Ø¯Ù‚ÙŠÙ‚Ø©)</div><div><strong>35 Ø¬</strong></div></div>
          <div class="rate-row"><div>PS4 â€” Ù…Ù„ØªÙŠ (4 Ø¯Ø±Ø§Ø¹Ø§Øª)</div><div><strong>45 Ø¬</strong></div></div>

          <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="muted">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</div>
            <div class="big-total" id="count">6</div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn" onclick="exportCSV()">ØªØµØ¯ÙŠØ± CSV</button>
            <button class="ghost" onclick="downloadHTML()">ØªØ­Ù…ÙŠÙ„ ÙƒÙ…Ù„Ù</button>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- floating record icon -->
  <button class="record-btn" title="Ø§Ù„Ø³Ø¬Ù„" onclick="openHistory()">
    ğŸ“‹
    <span style="font-size:11px">Ø§Ù„Ø³Ø¬Ù„</span>
  </button>

  <!-- history modal -->
  <div class="modal" id="historyModal">
    <div class="box">
      <header>
        <strong>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø¬Ù„Ø³Ø§Øª</strong>
        <div>
          <button class="ghost" onclick="downloadHistory()">ØªØ­Ù…ÙŠÙ„ CSV</button>
          <button class="close" onclick="closeHistory()">âœ•</button>
        </div>
      </header>
      <div class="history-table" id="historyContent"></div>
    </div>
  </div>

<script>
// CONFIG & state
const CONFIG = {
  devices: [
    {id:1,name:'PS5 - 1', type:'ps5'},
    {id:2,name:'PS5 - 2', type:'ps5'},
    {id:3,name:'PS5 - 3', type:'ps5'},
    {id:4,name:'PS5 - 4', type:'ps5'},
    {id:5,name:'PS5 - 5', type:'ps5'},
    {id:6,name:'PS4 - 1', type:'ps4'}
  ],
  rates: { ps5:45, ps5_multi:55, ps4:35, ps4_multi:45 }
};

let state = loadState();
function loadState(){
  const raw = localStorage.getItem('algen_state_final');
  if(!raw){
    const s = {sessions:{}, history:[]};
    CONFIG.devices.forEach(d=> s.sessions[d.id] = {active:false,start:0,mode:'normal',accum:0,cost:0, started_at_display:'', ended_at_display:'', _logged_accum:0, _last_start_ts:null});
    localStorage.setItem('algen_state_final', JSON.stringify(s));
    return s;
  }
  try{ return JSON.parse(raw);}catch(e){ localStorage.removeItem('algen_state_final'); return loadState(); }
}
function saveState(){ localStorage.setItem('algen_state_final', JSON.stringify(state)); }

// time formatting 12-hour with AM/PM Arabic suffix
function format12(ts){
  if(!ts) return '';
  const d = new Date(ts*1000);
  let hours = d.getHours();
  const minutes = d.getMinutes().toString().padStart(2,'0');
  const ampm = hours>=12? 'Ù…' : 'Øµ';
  hours = hours%12; if(hours===0) hours = 12;
  return `${hours}:${minutes} ${ampm}`;
}

// UI rendering
function renderDevices(){
  const wrap = document.getElementById('devices'); wrap.innerHTML='';
  CONFIG.devices.forEach(d=>{
    const s = state.sessions[d.id];
    const rate = s.mode==='multi' ? (d.type==='ps5'? CONFIG.rates.ps5_multi:CONFIG.rates.ps4_multi) : (d.type==='ps5'? CONFIG.rates.ps5:CONFIG.rates.ps4);
    const elapsed = s.active ? Math.floor((Date.now()/1000)-s.start + s.accum) : s.accum;
    const cost = (elapsed/3600)*rate;
    const div = document.createElement('div'); div.className='dev';
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><h3>${d.name}</h3><div class="muted">${d.type.toUpperCase()}</div></div>
        <div style="text-align:left">
          <div class="time" id="time_${d.id}">${fmtDuration(elapsed)}</div>
          <div class="cost" id="cost_${d.id}">${cost.toFixed(2)} Ø¬</div>
        </div>
      </div>
      <div class="controls">
        <button style="background:linear-gradient(90deg,var(--accent1),var(--accent2));border:none;color:white;padding:8px 10px;border-radius:10px" onclick="toggle(${d.id})" id="btn_${d.id}">${s.active? 'Ø¥ÙŠÙ‚Ø§Ù':'Ø§Ø¨Ø¯Ø£'}</button>
        <select class="select" onchange="changeMode(${d.id}, this.value)">
          <option value="normal" ${s.mode==='normal'?'selected':''}>Ø¹Ø§Ø¯ÙŠ</option>
          <option value="multi" ${s.mode==='multi'?'selected':''}>Ù…Ù„ØªÙŠ (4 Ø¯Ø±Ø§Ø¹Ø§Øª)</option>
        </select>
        <button class="ghost small" onclick="clearDevice(${d.id})">Ù…Ø³Ø­</button>
      </div>
      <div style="margin-top:8px" class="muted">
        <div>ğŸ•’ Ø¨Ø¯Ø£ Ù…Ù†: <strong id="started_${d.id}">${s.started_at_display||''}</strong></div>
        <div>â° Ø§Ù†ØªÙ‡Ù‰ Ø¹Ù†Ø¯: <strong id="ended_${d.id}">${s.ended_at_display||''}</strong></div>
      </div>
    `;
    wrap.appendChild(div);
  });
  document.getElementById('count').innerText = CONFIG.devices.length;
}

function fmtDuration(sec){
  sec = Math.max(0, Math.floor(sec));
  const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60;
  if(h>0) return `${h}Ø³ ${m}Ø¯ ${s}Ø«`;
  if(m>0) return `${m}Ø¯ ${s}Ø«`;
  return `${s}Ø«`;
}

// toggle start/stop
function toggle(id){
  const s = state.sessions[id];
  if(s.active){
    // stop
    const now = Math.floor(Date.now()/1000);
    s.accum += now - s.start;
    s.start = 0; s.active = false;
    s.ended_at_display = format12(now);
    // compute cost for this session only (duration since last start)
    const session_duration = (now - (s._last_start_ts || now));
    const used_rate = s.mode==='multi' ? (dById(id).type==='ps5'? CONFIG.rates.ps5_multi : CONFIG.rates.ps4_multi) : (dById(id).type==='ps5'? CONFIG.rates.ps5 : CONFIG.rates.ps4);
    const cost = (session_duration/3600)*used_rate;
    // push history (prepend)
    state.history = state.history || [];
    state.history.unshift({
      device_id: id,
      device_name: dById(id).name,
      start_ts: s._last_start_ts || (now - session_duration),
      end_ts: now,
      duration_sec: session_duration,
      cost: Math.round(cost*100)/100,
      start_display: s.started_at_display || format12(s._last_start_ts || (now-session_duration)),
      end_display: format12(now)
    });
    // clear temp markers
    s._last_start_ts = null;
  } else {
    // start
    const now = Math.floor(Date.now()/1000);
    s.start = now;
    s.active = true;
    s.started_at_display = format12(now);
    s.ended_at_display = '';
    s._last_start_ts = now;
  }
  calculateCosts(); saveState(); renderDevices(); renderSessions();
}

// helper to get device by id
function dById(id){ return CONFIG.devices.find(x=>x.id===id) || {name:'Unknown', type:'ps5'}; }

function changeMode(id, mode){ const s = state.sessions[id]; s.mode = mode; saveState(); renderDevices(); renderSessions(); }

function clearDevice(id){ if(!confirm('Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ')) return; state.sessions[id] = {active:false,start:0,mode:'normal',accum:0,cost:0, started_at_display:'', ended_at_display:'', _logged_accum:0, _last_start_ts:null}; saveState(); renderDevices(); renderSessions(); }

function resetAll(){ if(!confirm('ØªØµÙÙŠØ± ÙƒÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©ØŸ')) return; CONFIG.devices.forEach(d=> state.sessions[d.id] = {active:false,start:0,mode:'normal',accum:0,cost:0, started_at_display:'', ended_at_display:'', _logged_accum:0, _last_start_ts:null}); state.history = []; saveState(); renderDevices(); renderSessions(); }

function calculateCosts(){
  CONFIG.devices.forEach(d=>{
    const s = state.sessions[d.id];
    const rate = s.mode==='multi' ? (d.type==='ps5'? CONFIG.rates.ps5_multi:CONFIG.rates.ps4_multi) : (d.type==='ps5'? CONFIG.rates.ps5:CONFIG.rates.ps4);
    const elapsed = s.active ? Math.floor((Date.now()/1000)-s.start + s.accum) : s.accum;
    s.cost = (elapsed/3600)*rate;
  });
}

function collectAll(){ calculateCosts(); let total=0; let details=[]; CONFIG.devices.forEach(d=>{ const s=state.sessions[d.id]; total+=s.cost; details.push(`${d.name}: ${s.cost.toFixed(2)} Ø¬`); }); alert('Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: '+total.toFixed(2)+' Ø¬\n\n'+details.join('\n')); }

function renderSessions(){ const cont = document.getElementById('sessions_table'); let html = '<table><thead><tr><th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th></tr></thead><tbody>'; CONFIG.devices.forEach(d=>{ const s = state.sessions[d.id]; const elapsed = s.active ? Math.floor((Date.now()/1000)-s.start + s.accum) : s.accum; html += `<tr><td>${d.name}</td><td>${s.active? 'Ø´ØºØ§Ù„':'Ù…ØªÙˆÙ‚Ù'}</td><td>${fmtDuration(elapsed)}</td><td>${(s.cost||0).toFixed(2)} Ø¬</td></tr>`; }); html += '</tbody></table>'; cont.innerHTML = html; }

// HISTORY modal
function openHistory(){ document.getElementById('historyModal').style.display = 'flex'; renderHistory(); }
function closeHistory(){ document.getElementById('historyModal').style.display = 'none'; }

function renderHistory(){
  const cont = document.getElementById('historyContent');
  if(!state.history || state.history.length===0){ cont.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯.</div>'; return; }
  let html = '<table><thead><tr><th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th>Ø¨Ø¯Ø§ÙŠØ©</th><th>Ù†Ù‡Ø§ÙŠØ©</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th></tr></thead><tbody>';
  state.history.forEach(rec=>{
    html += `<tr><td>${rec.device_name}</td><td>${rec.start_display}</td><td>${rec.end_display}</td><td>${fmtDuration(rec.duration_sec)}</td><td>${rec.cost.toFixed(2)} Ø¬</td></tr>`;
  });
  html += '</tbody></table>';
  cont.innerHTML = html;
}

function downloadHistory(){
  if(!state.history || state.history.length===0){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª Ù„ØªØ­Ù…ÙŠÙ„Ù‡Ø§.'); return; }
  const rows = [['device','start','end','duration_sec','cost']];
  state.history.forEach(r=> rows.push([r.device_name, r.start_display, r.end_display, r.duration_sec, r.cost]));
  const csv = rows.map(r=> r.map(c=> `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'algen_history.csv'; a.click(); URL.revokeObjectURL(url);
}

// export current data
function exportCSV(){ calculateCosts(); let rows=[['session_id','device','status','duration_sec','cost']]; CONFIG.devices.forEach(d=>{ const s=state.sessions[d.id]; const elapsed = s.active ? Math.floor((Date.now()/1000)-s.start + s.accum) : s.accum; rows.push([d.id, d.name, s.active? 'active':'stopped', elapsed, (s.cost||0).toFixed(2)]); }); const csv = rows.map(r=> r.map(c=> `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n'); const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'algen_sessions.csv'; a.click(); URL.revokeObjectURL(url); }

function downloadHTML(){ const html = '<!doctype html>\\n' + document.documentElement.outerHTML; const blob = new Blob([html], {type:'text/html;charset=utf-8'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'algen.html'; a.click(); URL.revokeObjectURL(url); }

// live update
setInterval(()=>{ calculateCosts(); renderDevices(); renderSessions(); saveState(); }, 1000);

// init
renderDevices(); renderSessions();
</script>
</body>
</html>
